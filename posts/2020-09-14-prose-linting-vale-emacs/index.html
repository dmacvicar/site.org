<!doctype html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-1687066-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-1687066-2');
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous">
  <link href="http://localhost:8000/css/site.css" rel="stylesheet">
  <link rel="preload" href="http://localhost:8000/fonts/blockzone-webfont.woff2" as="font" type="font/woff2" crossorigin>
  
</head>
<body>
  <header id="preamble" class="status">
    <div class="logo">
      <a href="/">
        <img src="https://www.gravatar.com/avatar/3b67365812827fa25df5093b38934a8f?s=80" class="avatar" alt="My photo"/>
      </a>
      <a href="/"><h2>Duncan Mac-Vicar P.</h2></a>
      <div id="social">
        <a title="dmacvicar on Github" href="https://github.com/dmacvicar">
        <i class="fa-brands fa-github"></i>
      </a>
      <a title="dmacvicar on Hacker News" href="https://news.ycombinator.com/user?id=dmacvicar">
        <i class="fa-brands fa-hacker-news"></i>
      </a>
      <a title="dmacvicar on Twitter" href="https://twitter.com/dmacvicar">
        <i class="fa-brands fa-twitter"></i>
      </a>
      <a title="RSS feed" id="atom" href="posts/rss.xml">
        <i class="fa-solid fa-rss"></i>
      </a>
    </div>
   <sub>I am inspired by creating software and learning from others. When things break, I fix them or go play guitar <i class="fa-solid fa-guitar"></i> ...</sub>
 </header>
 <main id="main">
 
<h1>Prose linting with Vale and Emacs</h1>
<div class="date">14 Sep 2020</div>
<div class="content">
  <p>
I have set myself the goal to improve my writing. I read some books and articles on the topic, but I am also looking for real-time feedback. I am not a native english speaker.
</p>

<p>
I found about <a href="https://www.grammarly.com/">Grammarly</a> on twitter, but there is no way I will send my emails and documents to their server as I type. That is how I started to look for an offline solution.
</p>

<p>
I found <a href="https://github.com/amperser/proselint">proselint</a> but it seems inactive since 2018. As I tried to integrate it with Emacs, I learned about <a href="https://github.com/bnbeckwith/writegood-mode">write-good mode</a>. This Emacs mode has two flaws:
</p>

<ul class="org-ul">
<li>The implementation is too &ldquo;simple&rdquo; (regexps)</li>
<li>The integration works like a full Emacs mode. Mixing the linting with presentation.</li>
</ul>

<p>
Through those projects, I learned about the original article <a href="http://matt.might.net/articles/shell-scripts-for-passive-voice-weasel-words-duplicates/">3 shell scripts to improve your writing, or &ldquo;My Ph.D. advisor rewrote himself in bash.&rdquo;</a>.
</p>

<p>
I found a more sophisticated and extensible tool called <a href="https://github.com/btford/write-good">write-good</a>, implemented in Javascript/node, which means I will not be able to package it.
</p>

<p>
I decided to try to write one. I found the Go library <a href="https://github.com/jdkato/prose">prose</a>. It allows to iterate over tokens, entities and sentences. Iterating over the tokens gives access to tags:
</p>

<div class="org-src-container">
<pre class="src src-go">for _, tok := range doc.Tokens() {
	fmt.Println(tok.Text, tok.Tag, tok.Label)
	// Go NNP B-GPE
	// is VBZ O
	// an DT O
	// ...
}
</pre>
</div>

<p>
For example, the text &ldquo;At dinner, six shrimp were eaten by Harry&rdquo; produces the following tags:
</p>

<pre class="example">
Harry PERSON
At IN
dinner NN
, ,
six CD
shrimp NN
were VBD
eaten VBN
by IN
Harry NNP
</pre>

<p>
The combination <code>VBD</code> (verb, past tense )and <code>VBN</code> (verb, past participle) can be used to detect passive voice, one of the guidelines of &ldquo;good-write&rdquo;.
</p>

<p>
Soon I figured out that the tokens do not give access to the locations. I started to see who is using the code, looking for examples.
</p>

<p>
I realized the author of the library uses the library to power <a href="https://github.com/errata-ai/vale">vale</a>, a prose linter implemented in go. What I was trying to write.
</p>

<p>
The <a href="https://docs.errata.ai/vale/about">vale documentation</a> revealed the tool is more than I was looking for. It includes <a href="https://github.com/errata-ai/vale/tree/master/styles/write-good">write-good</a> definitions as part of its example styles. There are examples for Documentation CI which include how <a href="https://docs.errata.ai/vale/config">Gitlab, Linode and Homebrew</a> use it to lint their documentation. It even has a <a href="https://github.com/errata-ai/vale-action">Github action</a>.
</p>

<p>
Nothing left other than to integrate with Emacs. There is no need to write a full mode for that. A simple <a href="https://www.flycheck.org">Flycheck</a> checker should do. Turns out, it already <a href="https://melpa.org/#/flycheck-vale">exists</a>, but I could not make it work.
</p>

<p>
The existing Emacs checker uses <i>vale</i> JSON output (<code>--output JSON</code>), which gives access to all details of the result. We can write the simplest checker from scratch, by recognizing patterns with <code>--output line</code>:
</p>

<div class="org-src-container">
<pre class="src src-elisp">(flycheck-define-checker vale
  <span class="org-string">"A checker for prose"</span>
  <span class="org-builtin">:command</span> (<span class="org-string">"vale"</span> <span class="org-string">"--output"</span> <span class="org-string">"line"</span>
            source)
  <span class="org-builtin">:standard-input</span> nil
  <span class="org-builtin">:error-patterns</span>
  ((<span class="org-warning">error</span> line-start (file-name) <span class="org-string">":"</span> line <span class="org-string">":"</span> column <span class="org-string">":"</span> (id (one-or-more (not (any <span class="org-string">":"</span>)))) <span class="org-string">":"</span> (message) line-end))
  <span class="org-builtin">:modes</span> (markdown-mode org-mode text-mode)
  )
(add-to-list 'flycheck-checkers 'vale 'append)
</pre>
</div>

<p>
Note that for this to work, you need <i>vale</i> in your <code>PATH</code>. I packaged it in <a href="https://build.opensuse.org/package/show/home:dmacvicar/vale">the Open Build Service.</a> You need also a <code>$HOME/.vale.ini</code> or in the root of your project:
</p>

<pre class="example">
StylesPath = /usr/share/vale/styles
Vocab = Blog
[*.txt]
BasedOnStyles = Vale, write-good
[*.md]
BasedOnStyles = Vale, write-good
[*.org]
BasedOnStyles = Vale, write-good
</pre>

<p>
And with this Emacs works:
</p>


<figure id="org519f2ef">
<img src="images/emacs.png" alt="emacs.png">

</figure>

<p>
Due to <code>--output line</code> not providing severity, every message shows as error.
</p>

<p>
I am looking forward to integrate <i>vale</i> in some documentation, develop custom styles and why not, investigate and fix the original <i>flycheck-vale</i> project.
</p>

<p>
Also pending is to expand the configuration to work with my <a href="https://www.djcbsoftware.nl/code/mu/mu4e.html">Emacs based mail client</a>, which should be a matter of hooking into <i>mu4e</i> compose mode.
</p>

<p>
While writing this post, I had to fix the unintended use of passive voice tens of times. Valuable feedback.
</p>

</div>

 </main>

<hr/>
 
 <p class='disclaimer'>The postings on this site are my own and don't necessarily represent my employerâ€™s positions, strategies or opinions.</p>

  <p>Last updated 06 Jan 2025. Built with <a href="https://www.gnu.org/software/emacs/">Emacs</a> 27.2 (<a href="https://orgmode.org/">Org</a> mode 9.4.4). <a href="http://localhost:8000/readme.html">Details</a>.</p>
</body>
</html>
