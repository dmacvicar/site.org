<!doctype html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-1687066-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-1687066-2');
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous">
  <link href="http://localhost:8000/css/site.css" rel="stylesheet">
  <link rel="preload" href="http://localhost:8000/fonts/blockzone-webfont.woff2" as="font" type="font/woff2" crossorigin>
  
</head>
<body>
  <header id="preamble" class="status">
    <div class="logo">
      <a href="/">
        <img src="https://www.gravatar.com/avatar/3b67365812827fa25df5093b38934a8f?s=80" class="avatar" alt="My photo"/>
      </a>
      <a href="/"><h2>Duncan Mac-Vicar P.</h2></a>
      <div id="social">
        <a title="dmacvicar on Github" href="https://github.com/dmacvicar">
        <i class="fa-brands fa-github"></i>
      </a>
      <a title="dmacvicar on Hacker News" href="https://news.ycombinator.com/user?id=dmacvicar">
        <i class="fa-brands fa-hacker-news"></i>
      </a>
      <a title="dmacvicar on Twitter" href="https://twitter.com/dmacvicar">
        <i class="fa-brands fa-twitter"></i>
      </a>
      <a title="RSS feed" id="atom" href="posts/rss.xml">
        <i class="fa-solid fa-rss"></i>
      </a>
    </div>
   <sub>I am inspired by creating software and learning from others. When things break, I fix them or go play guitar <i class="fa-solid fa-guitar"></i> ...</sub>
 </header>
 <main id="main">
 
<h1>Migrating from Jekyll to org-mode and Github Actions</h1>
<div class="date">03 Sep 2019</div>
<div class="content">
  
<section id="outline-container-introduction" class="outline-2">
<h2 id="introduction">Introduction</h2>
<div class="outline-text-2">
<p>
My <a href="http://mac-vicar.eu">website</a> has been generated until now by <a href="https://pages.github.com/">Github pages</a> using a static site generator tool called <a href="https://jekyllrb.com/">Jekyll</a> and the <a href="http://jekyllthemes.org/themes/lagom/">Lagom</a> theme.
</p>
</div>

<div id="outline-container-github-pages" class="outline-3">
<h3 id="github-pages">Github Pages</h3>
<div class="outline-text-3">
<p>
Github Pages allows to host static sites in Github repositories for free. It is very simple, you would just put the website in a branch (eg. <code>gh-pages</code>) and Github will serve it as <i>username.github.io/repo</i>, or via a custom domain by adding a simple <i>CNAME</i> text file to the repository.
</p>
</div>
</div>

<div id="outline-container-static-site-generators" class="outline-3">
<h3 id="static-site-generators">Static Site Generators</h3>
<div class="outline-text-3">
<p>
If you did not want to write <i>HTML</i> directly, you could use a <a href="https://en.wikipedia.org/wiki/Web_template_system#Static_site_generators">static site generator</a> to keep a set of templates and content in the git repository and putting the output of the generator (the <i>HTML</i> files) into the <code>gh-pages</code> branch to be served by Github.
</p>

<p>
In addition to be able to write the content in <a href="https://github.github.com/gfm/">Markdown</a>, site generators made much easier to maintain content like a blog, with features like different templates for posts, code syntax highlighting, drafts and support for themes, which allowed to change the look and feel of the site by just changing one configuration option and just re-generating it.
</p>

<p>
If you wanted this process to be automatic, you could run the generation as part of some CI job (eg. with <a href="https://travis-ci.org/">TravisCI</a>), so that the site is re-generated when its sources are updated.
</p>
</div>
</div>

<div id="outline-container-jekyll-support-in-github-pages" class="outline-3">
<h3 id="jekyll-support-in-github-pages">Jekyll support in Github Pages</h3>
<div class="outline-text-3">
<p>
Jekyll is one of these site generators and it was the most popular for a while. The nice part was that if you used Jekyll, Github Pages will generate your website automatically, without having to setup CI. Just push your changes and a minute later your site was published.
</p>

<p>
On the other hand, you were limited by using the Jekyll version that was installed at Github, and you could not just install any add-on that you wanted. You did not control the environment to the level you did in a typical CI.
</p>
</div>
</div>
</section>

<section id="outline-container-moving-away-from-jekyll" class="outline-2">
<h2 id="moving-away-from-jekyll">Moving away from Jekyll</h2>
<div class="outline-text-2">
<p>
Jekyll just worked. I can&rsquo;t complain about it. However, I feel too tied to the Github Pages environment. You had to use a Jekyll version that was close to a year behind and live with the plugins that the environment supported, and nothing more.
</p>

<p>
If I was to setup my own CI workflow to overcome this limitation, why keep using Jekyll?. <a href="https://gohugo.io/">Hugo</a> started to feel faster, easier to deploy locally and mostly compatible.
</p>

<p>
I have been using Emacs for more than 10 years. 3 years ago, I switched mail clients from Thunderbird to <a href="https://www.djcbsoftware.nl/code/mu/mu4e.html">mu4e</a> on top of <a href="https://www.gnu.org/software/emacs/">Emacs</a>. Then I discovered <a href="https://orgmode.org/">org-mode</a> as a plain-text personal organization system and gradually started to live more time inside emacs. Microsoft did a so good job with <a href="https://code.visualstudio.com/">Visual Studio Code</a> that for a moment I thought I would not resist. However, Microsoft created an ecosystem by making the interaction with programming languages a standard, via the <a href="https://microsoft.github.io/language-server-protocol/">Language Server Protocol</a>, and <a href="https://github.com/emacs-lsp/lsp-mode">emacs-lsp</a> made my programming experience with emacs just better.
</p>

<p>
I knew that <code>org-mode</code> was quite good at exporting. After I saw a couple of websites generated from org, I started to toy with the idea of using org too. It could also be a good chance to learn <a href="https://www.gnu.org/software/emacs/manual/eintr.html">Emacs Lisp</a> for real. So I started learning about org and websites.
</p>
</div>
</section>

<section id="outline-container-inspiration" class="outline-2">
<h2 id="inspiration">Inspiration</h2>
<div class="outline-text-2">
<p>
As I did not know where to start, I started by reading a lot of solutions by other people, documentation, posts, etc.
</p>

<p>
Most of the structure of the final solution, its ideas, conventions, configuration and some snippets were taken from the following projects:
</p>

<ul class="org-ul">
<li><a href="https://gitlab.com/to1ne/blog">Toon Claes&rsquo;s blog</a></li>
<li>Example <a href="http://orgmode.org">org-mode</a> website using <a href="http://pages.gitlab.io/">GitLab Pages</a> by Rasmus</li>
<li><a href="https://github.com/bastibe/org-static-blog">https://github.com/bastibe/org-static-blog</a></li>
<li>The theme is a port of the original <a href="https://github.com/swanson/lagom">Lagom</a> theme I was using with Jekyll</li>
</ul>
</div>
</section>

<section id="outline-container-implementation" class="outline-2">
<h2 id="implementation">Implementation</h2>
<div class="outline-text-2" id="text-implementation">
</div>
<div id="outline-container-principles" class="outline-3">
<h3 id="principles">Principles</h3>
<div class="outline-text-3">
<p>
Once I had a clear picture of the domain, I made up my mind of how I wanted it and my own requirements:
</p>

<ul class="org-ul">
<li>Use as much standard packages as possible. eg. <a href="https://orgmode.org/manual/Publishing.html">org-publish</a>. Avoid using <a href="https://melpa.org/#/?q=blog">&ldquo;frameworks&rdquo;</a> on top of emacs/org</li>
<li>Links to old posts should still work (I had configured Jekyll to use <code>/year/month/day/post-name.html</code> )</li>
<li>Initially, I thought about the ability to migrate content gradually, eg. supporting Markdown posts for a while</li>
<li>Self contained. Everything should be in a single git repo, not interfering with my <code>emacs.d</code>.</li>
<li>Ability to run it from the command line, so that <i>CI</i> could be used to automatically generate the site from <i>git</i></li>
</ul>
</div>
</div>

<div id="outline-container-emacs-concepts-to-be-used" class="outline-3">
<h3 id="emacs-concepts-to-be-used">Emacs concepts to be used</h3>
<div class="outline-text-3">
<p>
There are a bunch of emacs concepts that help putting all the pieces together:
</p>
</div>

<div id="outline-container-emacs-batch-mode" class="outline-4">
<h4 id="emacs-batch-mode">Emacs batch mode</h4>
<div class="outline-text-4">
<p>
While I could have most of the configuration in my <code>~/.emacs.d/init.el</code>, I wanted a self-contained solution, not depending on my personal emacs configuration being available.
</p>

<p>
There are a bunch of <i>emacs</i> options that help achieving this:
</p>

<pre class="example" id="org528f608">
$ emacs --help
...
--batch                     do not do interactive display; implies -q
...
--no-init-file, -q          load neither ~/.emacs nor default.el
...
--load, -l FILE         load Emacs Lisp FILE using the load function
...
--funcall, -f FUNC      call Emacs Lisp function FUNC with no arguments
...
</pre>

<p>
With these options, we can put all our configuration and helper functions in a <i>lisp</i> file, call emacs as a script engine, skip our personal configuration, have emacs load the file with the configuration, and call a function to run everything.
</p>
</div>
</div>

<div id="outline-container-org-mode-export-ox" class="outline-4">
<h4 id="org-mode-export-ox">org-mode Export (ox)</h4>
<div class="outline-text-4">
<p>
<i>org-mode</i> includes an <a href="https://orgmode.org/manual/Exporting.html">Export subsystem</a> with several target formats (<i>ASCII</i>, <a href="https://en.wikipedia.org/wiki/Beamer_(LaTeX)"><i>beamer</i></a>, <i>HTML</i>, etc). Every backend/converter is a set of functions that take already parsed <i>org-mode</i> structures (eg. a list, a timestamp, a paragraph) and converts it to the target format. <a href="https://orgmode.org/worg/">Worg</a>, a section of the Org-mode web site that is written by a volunteer community of Org-mode fans, provide <a href="https://orgmode.org/worg/dev/org-export-reference.html">documentation on how to define an export backend</a> (<i>org-export-define-backend</i>). From here is important to understand <a href="https://orgmode.org/worg/dev/org-export-reference.html#filter-system">the filter system</a> and <i>org-export-define-derived-backend</i>, which allows to define a backend by overriding an existing one. This is what I will end using to tweak, for example, how timestamps are exported.
</p>
</div>
</div>

<div id="outline-container-org-publish" class="outline-4">
<h4 id="org-publish">org-publish</h4>
<div class="outline-text-4">
<p>
<i>org-mode</i> includes a <a href="https://orgmode.org/manual/Publishing.html">publishing management system</a> that helps exporting a interlinked set of org files. There is a <a href="https://orgmode.org/worg/org-tutorials/org-publish-html-tutorial.html">nice tutorial</a> also available.
</p>

<p>
Using <i>org-publish</i> boils down to defining a list of components (blog posts, assets, <i>RSS</i>), their options (base directory, target directory, includes/excludes, publishing function) being the <i>publishing function</i> one of the most interesting ones, as <i>org</i> comes with a few predefined ones eg. <i>org-html-publish-to-html</i> to publish <i>HTML</i> files and <i>org-publish-attachment</i> to publish static assets. The most important thing to learn here is that you can wrap those in your own to do additional stuff and customize publishing very easily. I use this for example, to skip draft posts or to write redirect files for certain posts in addition to the post itself.
</p>
</div>
</div>
</div>

<div id="outline-container-the-solution" class="outline-3">
<h3 id="the-solution">The solution</h3>
<div class="outline-text-3" id="text-the-solution">
</div>
<div id="outline-container-directory-structure" class="outline-4">
<h4 id="directory-structure">Directory Structure</h4>
<div class="outline-text-4">
<pre class="example" id="org5c5fb9f">
├── CNAME
├── css
│   ├── index.css
│   └── site.css
├── index.org
├── Makefile
├── posts
│   ├── 2019-10-31-some-post
│   │   └── index.org
│   ├── 2014-06-11-other-post
│   │   ├── images
│   │   │   ├── someimage.png
│   │   │   └── another-image.png
│   │   └── index.org
│   ├── archive.org
│   └── posts.org
├── public
├── publish.el
├── README.org
├── snippets
│   ├── analytics.js
│   ├── postamble.html
│   └── preamble.html
└── tutorials
    └── how-to-something
        └── index.org
</pre>

<p>
Inside the directory tree, you can find:
</p>

<ul class="org-ul">
<li>a <i>publish.el</i> file with the <i>org-publish</i> project description and all the support code and helper functions</li>
<li>a <i>CNAME</i> file for telling <a href="https://help.github.com/en/articles/using-a-custom-domain-with-github-pages">Github Pages my domain name</a></li>
<li>a folder with a <i>CSS</i> file for all the site. Another one that is included only on the index page</li>
<li>a <i>Makefile</i> that just calls emacs with the parameters we described above and calls the function <i>duncan-publish-all</i></li>
<li>a subdirectory for each post, and another one for tutorials</li>
<li>a <i>public</i> directory where the output files are generated and the static assets copied</li>
<li>a <i>snippets</i> directory with the preamble, postamble and Google analytics snippets</li>
</ul>
</div>
</div>

<div id="outline-container-publish-el" class="outline-4">
<h4 id="publish-el">publish.el</h4>
<div class="outline-text-4">
<p>
The main file containing code and configuration includes a few custom publishing functions that are used as hooks for publishing and creating sitemaps.
</p>
</div>
</div>

<div id="outline-container-org-publish-project" class="outline-4">
<h4 id="org-publish-project">org-publish project</h4>
<div class="outline-text-4">
<p>
The <i>org-publish</i> project (<i>org-publish-project-alist</i>) is defined in the variable <i>duncan&#x2013;publish-project-alist</i>, and defines the following components:
</p>

<ul class="org-ul">
<li><p>
<i>blog</i>
</p>

<p>
This components reads all <i>org</i> files in the <code>./posts/</code> directory, and exports them to <i>HTML</i> using <i>duncan/org-html-publish-post-to-html</i> as the publishing function.
</p>

<p>
This function injects the date as the page subtitle in the property list before delegating to the original function. This is a common pattern that you can use to override the publishing function. Note that <i>subtitle</i> is a recognized configuration property of the <i>HTML</i> export backend.
</p></li>
</ul>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">duncan/org-html-publish-post-to-html</span> (plist filename pub-dir)
  <span class="org-doc">"Wraps org-html-publish-to-html.  Append post date as subtitle to PLIST.  FILENAME and PUB-DIR are passed."</span>
  (<span class="org-keyword">let</span> ((project (cons 'blog plist)))
    (plist-put plist <span class="org-builtin">:subtitle</span>
               (format-time-string <span class="org-string">"%b %d, %Y"</span> (org-publish-find-date filename project)))
    (duncan/org-html-publish-to-html plist filename pub-dir)))
</pre>
</div>

<p>
The function also checks the <code>#+REDIRECT_TO</code> property, and generates redirect pages accordingly, by spawning another export to a different path in the same <code>pub_dir</code>.
</p>

<p>
This component is configured with a sitemap function which, even if goes through all posts, it is programmed to take only a few ones and write an <i>org</i> file with links to them. This file (<i>posts.org</i>) is then included in <i>index.org</i> and used as the list of recent posts.
</p>

<ul class="org-ul">
<li><p>
<i>archive-rss</i>
</p>

<p>
This component also operates on <code>/.posts/</code>, but instead of generating HTML, it uses the <i>RSS</i> backend to generate the full site archive as <i>RSS</i>.
</p>

<p>
The sitemap function is also configured, like in the <i>blog</i> component, but this function generates an org file with all posts, not just the latest ones. The <i>sitemap-format-entry</i> function is shared between the sitemaps functions, as the list of posts looks the same.
</p></li>
</ul>


<figure id="org9e81092">
<img src="images/sitemap-function.png" alt="sitemap-function.png">

</figure>

<ul class="org-ul">
<li><p>
<i>site</i>
</p>

<p>
The rest of the content of the site, including the <i>index.org</i> page and the generated <i>org</i> files for the archive (<i>archive.org</i>) and latest posts (<i>posts.org</i>).
</p></li>

<li><p>
<i>assets</i>
</p>

<p>
All files that are just copied over
</p></li>

<li><p>
<i>tutorials</i>
</p>

<p>
It works just like posts, but I setup each (don&rsquo;t expect to have many) to use the <a href="https://github.com/fniessen/org-html-themes">ReadTheOrg</a> theme. It uses the default <i>HTML</i> publishing function.
</p></li>
</ul>


<figure id="org78368cc">
<img src="images/readtheorg.png" alt="readtheorg.png">

</figure>
</div>
</div>

<div id="outline-container-export-workflow" class="outline-4">
<h4 id="export-workflow">Export workflow</h4>
<div class="outline-text-4">

<figure id="org10d1985">
<img src="images/publishing-function.png" alt="publishing-function.png">

</figure>
</div>
</div>
</div>

<div id="outline-container-look-feel" class="outline-3">
<h3 id="look-feel">Look &amp; Feel</h3>
<div class="outline-text-3">
<p>
I managed to port most of the <i>Lagom</i> look and feel by starting a CSS from scratch (learned <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/grid">CSS Grid</a> in the process) and manually fixing each difference. I was quite satisfied with the final result. I had to use some extra page-specific CSS to hide the title in the front-page, or to <a href="https://emacs.stackexchange.com/questions/36898/proper-way-to-add-to-org-entities-user">display</a> <a href="https://fontawesome.com/">FontAwesome</a> icons.
</p>
</div>

<div id="outline-container-before" class="outline-4">
<h4 id="before">Before</h4>
<div class="outline-text-4">

<figure id="orgb5256d9">
<img src="images/jekyll.png" alt="jekyll.png">

</figure>
</div>
</div>

<div id="outline-container-after" class="outline-4">
<h4 id="after">After</h4>
<div class="outline-text-4">

<figure id="org2802992">
<img src="images/org.png" alt="org.png">

</figure>
</div>
</div>
</div>
</section>

<section id="outline-container-publishing" class="outline-2">
<h2 id="publishing">Publishing</h2>
<div class="outline-text-2">
<p>
While locally you can test by running <i>emacs</i> via the <i>Makefile</i>, I wanted a new way to run the generation on every git push:
</p>

<ul class="org-ul">
<li>I started with <a href="https://travis-ci.com/">Travis</a>, but I could not find container jobs anymore. When I relalized that Ubuntu had an older Emacs version I just lost interest.</li>
<li>Gitlab was easy to get working. Not only because is very simple and elegant, but some of the examples I took inspiration from where already using it, along the <a href="https://github.com/iquiw/docker-alpine-emacs">Emacs Alpine</a> container image. However, I did not want to have everything in Github, except my site</li>
<li>Then I realized <a href="https://github.com/features/actions">Github Actions</a> was in beta, but I was not yet in. Until:</li>
</ul>

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">You’re in 🥰</p>&mdash; Nat Friedman (@natfriedman) <a href="https://twitter.com/natfriedman/status/1165778104280707072?ref_src=twsrc%5Etfw">August 26, 2019</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>

<div id="outline-container-setting-up-a-workflow-to-build-the-site" class="outline-3">
<h3 id="setting-up-a-workflow-to-build-the-site">Setting up a workflow to build the site</h3>
<div class="outline-text-3">
<p>
While, on Linux, Github actions run on Ubuntu, they allow you to execute an action inside a container.
</p>

<div class="org-src-container">
<pre class="src src-yaml">name: Build and publish to pages
on:
  push:
    branches:
    - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
      with:
	fetch-depth: 1
    - name: build
      env:
	ENV: production
      uses: docker://iquiw/alpine-emacs
      if: github.event.deleted == false
      with:
	args: ./build.sh
    - name: deploy
      uses: peaceiris/actions-gh-pages@v3
      if: success()
      with:
	github_token: ${{ secrets.GITHUB_TOKEN }}
	publish_dir: ./public
</pre>
</div>

<p>
Combining <a href="https://github.com/actions/checkout">actions/checkout</a>, our own build script running as a container <a href="https://github.com/iquiw/docker-alpine-emacs">docker://iquiw/alpine-emacs</a> inside the <i>VM</i>, and <a href="https://github.com/peaceiris/actions-gh-pages">peaceiris/actions-gh-pages</a> we get the desired results.
</p>

<p>
As a caveat, you need to setup a <i>personal access token</i> for the action, as the default one will not work and what gets pushed to the <i>gh-pages</i> will not show up in your website.
</p>

<p>
The experience with Github Actions has been very positive. I will definitely replace most of my TravisCI usage in my repositories. Kudos to the Github team.
</p>
</div>
</div>
</section>

<section id="outline-container-conclusions" class="outline-2">
<h2 id="conclusions">Conclusions</h2>
<div class="outline-text-2">
<p>
Not only I have a website powered by the tool I use daily, but it is also packed with awesome features. For example, the diagrams in this post are inlined as <a href="http://plantuml.com/">PlantUML</a> code in the <i>org</i> file and exported via <a href="https://orgmode.org/worg/org-contrib/babel/intro.html">Org Babel</a>.
</p>

<p>
It also gave me project to learn <i>Emacs Lisp</i>. I do plan to add some minor features, like blog tags or categories and perhaps commenting. The learning will also benefit personalizing my editor and mail client.
</p>

<p>
The source of this site is available <a href="https://github.com/dmacvicar/site.org">on <i aria-hidden='true' class='fa fa-github'></i> Github</a>.
</p>
</div>
</section>

</div>

 </main>

<hr/>
 
 <p class='disclaimer'>The postings on this site are my own and don't necessarily represent my employer’s positions, strategies or opinions.</p>

  <p>Last updated 06 Jan 2025. Built with <a href="https://www.gnu.org/software/emacs/">Emacs</a> undefined (<a href="https://orgmode.org/">Org</a> mode undefined). <a href="http://localhost:8000/readme.html">Details</a>.</p>
</body>
</html>
